<h1><%= @institution.name %></h1>

<ul class="nav nav-tabs tabRease nav-justified">
	<li id="info2" onclick="info2()"><a>Impactos Globales</a></li>
	<%if user_signed_in?%>
		<li id="info3" onclick="info3()"><a>Ofertas de Servicios (<%=@offerings.count%>)</a></li>
		<li id="info4" onclick="info4()"><a>Solicitudes de Servicios (<%=@requests.count%>)</a></li>
	<%end%>

</ul>
<div class="borderTab">
	<div id="impacto">
		<h2>Datos importantes</h2>
		<br><%= image_tag @institution.logo.url(:mini) %>
		<p><strong>Sitio web:</strong> <%= link_to @institution.name, @institution.web%></p>
		<p>
			<strong>AS para <%=@institution.name%>: </strong>
			<%if @institution.description.present?%>
				<i>"<%=@institution.description%>"</i>
			<%else%>
				El encargado aún no ha escrito sobre su institución.
			<%end%>
		</p>
		<hr>
		<h2>Impactos Globales</h2>
		<p><strong>Experiencias Totaltes</strong>: <%=@experiences.count%><br></p>
		<p><strong>Estudiantes impactados </strong>: <%=@experiences.sum("participants")%></p>
		<p><strong>Miembros de comunidades impactados </strong>: <%=@experiences.sum("benefited")%></p>
		<hr>
		<h2>Ultimas experiencia realizadas</h2>
		<div class="panel-body">
			<table class="tabla-rease">
				<tr>
					<th><strong>Nombre</strong></th>
					<th><strong>Fecha</strong></th>
					<th><strong>Descargar</strong></th>

				</tr>
				<%@experiences.last(5).each do |experience|%>
				<tr>
					<td><%=truncate(experience.title, length: 60)%></td>
					<td><%=l experience.created_at%></td>
					<td><%=link_to image_tag("Extensiones/pdf.gif"), experience_path(experience, format: "pdf"), :target=>'_blank'%></td>
				</tr>
				<%end%>
			</table>
		</div>
	</div>

	<div id="ofertas">
		<%if @offerings.present? %>
			<% @offerings.each do |offering| %>
				<div class="panel panel-default panelRease">
					<div class="panel-heading">
						<%if offering.user == current_user %>
							<i class="glyphicon glyphicon-tags"></i>
						<%end%>
						<%= link_to offering.title, offering, :class=>'a-white' %>
					</div>
					<div class="panel-body">
						<p><%=raw offering.resume %></p>
					</div>
				</div>
			<%end%>
		<%else%>
			<p>Actualmente <%@institution.name%> no posee Ofertas de Servicios activas</p>
		<%end%>
	</div>

	<div id="solicitudes">
		<%if @requests.present? %>
			<% @requests.each do |request| %>
				<div class="panel panel-default panelRease">
					<div class="panel-heading">
						<%if request.user == current_user %>
							<i class="glyphicon glyphicon-tags"></i>
						<%end%>
						<%= link_to request.title, request, :class=>'a-white' %>
					</div>
					<div class="panel-body">
						<p><%=raw request.resume %></p>
					</div>
				</div>
			<%end%>
		<%else%>
			<p>Actualmente <%@institution.name%> no posee Solicitudes de Servicios activas</p>
		<%end%>
	</div>
</div>

<%if user_signed_in?%>
	<h2>Miembros Actuales de <%=@institution.name%></h2>

	<ul class="nav nav-tabs tabRease nav-justified">
		<li id="user1" onclick="user1()"><a>Encargado AS</a></li>
		<li id="user2" onclick="user2()"><a>Profesores</a></li>
		<li id="user3" onclick="user3()"><a>Socios Comunitarios</a></li>
		<li id="user4" onclick="user4()"><a>Vinculadores Sociales</a></li>
	</ul>
	<div class="borderTab">
		<div id="Encargado">
			<h2>Datos del encargado AS de <%= @institution.name%></h2>
			
			<%if @manager.present?%>
				<%if !@manager.photo.blank?%>
					<%= image_tag @user.photo.url(:medium),:class=>'RoundPicture' %>
				<%end%>
				<p><strong>Nombre completo: </strong> <%= link_to @manager.name, @manager %> </p>
				<p><strong>Categoría:</strong> 
				<%if @manager.is_admin? %> Administrador <%end%>
				<%if @manager.category == 2%> Profesor <%end%>
				<%if @manager.category == 3%> Vinculador Social <%end%>
				<%if @manager.category == 4%> Socio Comunitario <%end%>
				</p>
				<p><strong>Rol de Usuario:</strong> 
				<%if @manager.autorization_level == 1%> Activo <%end%>
				<%if @manager.autorization_level == 2%> Adherente <%end%>
				</p>
				<p><strong>Correo: </strong> <%= @manager.email%></p>
			<%else%>
				<p>Actualmente no hay ningún usuario que sea el encargado AS de <%= @institution.name%></p>
				<%if current_user.is_admin?%>
					<%= form_for(@institution) do |f| %>
						<%= f.select :manager_id, @professors.collect {|prof| [prof.name, prof.id]},{:include_blank => "Seleccione un usuario como encargado AS"},{ :class => 'form-control'}%>
						<%= f.submit @action, :class=>"btn btn-lg btnCRUD",  data: { confirm: '¿Estás seguro que desea nombrar a este profesor como encargado AS de'+@institution.name }  %>
					<%end%>
				<%end%>
			<%end%>
		</div>
		<div id="Profesores">
			<%if @professors.present?%>
				<div class="panel-body">
					<table class="tabla-rease">
						<tr>
							<th><strong>Apodo</strong></th>
							<th><strong>Correo electrónico</strong></th>
							<th><strong>Ofertas disponibles</strong></th>
							<th><strong>Última Oferta</strong></th>

						</tr>
						<%@professors.each do |profesor|%>
							<tr>
								<td><%=link_to profesor.nickname, profesor%></td>
								<td><%= profesor.email%></td>
								<td><%=profesor.offerings.where(status:1).count%></td>
								<td>
									<%if profesor.offerings.where(status:1).count > 0 %>
										<%=link_to "Ver", profesor.offerings.where(status:1).last%>
									<%else%>
										--
									<%end%>								
								</td>
							</tr>
						<%end%>
					</table>
					<p>Profesores totales: <%=@professors.count%></p>
				</div>
			<%else%>
				<p>Actualmente, no hay profesores que pertenezca a <%= @institution.name%></p>
			<%end%>		
		</div>
		<div id="Socios">
			<%if @partners.present?%>
				<div class="panel-body">
					<table class="tabla-rease">
						<tr>
							<th><strong>Apodo</strong></th>
							<th><strong>Correo electrónico</strong></th>
							<th><strong>Ofertas disponibles</strong></th>
							<th><strong>Última Oferta</strong></th>

						</tr>
						<%@partners.each do |socio|%>
							<tr>
								<td><%=link_to socio.nickname, socio%></td>
								<td><%= socio.email%></td>
								<td><%=socio.requests.where(status:1).count%></td>
								<td>
									<%if socio.requests.where(status:1).count > 0 %>
										<%=link_to "Ver", socio.requests.where(status:1).last%>
									<%else%>
										--
									<%end%>								
								</td>
							</tr>
						<%end%>
					</table>
					<p>Socios comunitarios totales: <%=@partners.count%></p>
				</div>
			<%else%>
				<p>Actualmente, no hay socios comunitarios que pertenezca a <%= @institution.name%></p>
			<%end%>		
		</div>
		<div id="Vinculadores">
			<%if @brokers.present?%>
				<div class="panel-body">
					<table class="tabla-rease">
						<tr>
							<th><strong>Apodo</strong></th>
							<th><strong>Correo electrónico</strong></th>
							<th><strong>Ofertas disponibles</strong></th>
							<th><strong>Solicitudes disponibles</strong></th>

						</tr>
						<%@brokers.each do |vinculador|%>
							<tr>
								<td><%=link_to vinculador.nickname, vinculador%></td>
								<td><%= vinculador.email%></td>
								<td><%=vinculador.offerings.where(status:1).count%></td>
								<td><%=vinculador.requests.where(status:1).count%></td>
							</tr>
						<%end%>
					</table>
					<p>Vinculadores sociales totales: <%=@brokers.count%></p>
				</div>
			<%else%>
				<p>Actualmente, no hay vinculadores sociales que pertenezca a <%= @institution.name%></p>
			<%end%>		
		</div>
	</div>
	<br>
	<%if (current_user.is_admin? and !@manager.present?) or current_user==@manager%>
		<%= link_to 'Editar', edit_institution_path(@institution), :class =>"btn btn-lg" %>
		<%= link_to 'Volver', :back, :class =>"btn btn-lg" %>
	<%end%>
<%else%>
	<br><%= link_to 'Volver', :back, :class =>"btn btn-lg" %>
<%end%>


<script type="text/javascript">
	
document.getElementById("info2").className = "active";	
document.getElementById('impacto').style.display='block';
document.getElementById('ofertas').style.display='none';
document.getElementById('solicitudes').style.display='none';

function info2(){		
	document.getElementById('impacto').style.display='block';
	document.getElementById('ofertas').style.display='none';
	document.getElementById('solicitudes').style.display='none';
	document.getElementById("info2").className = "active";
	document.getElementById("info3").className = "";
	document.getElementById("info4").className = "";
}
function info3(){
	document.getElementById('impacto').style.display='none';
	document.getElementById('ofertas').style.display='block';
	document.getElementById('solicitudes').style.display='none';
	document.getElementById("info2").className = "";
	document.getElementById("info3").className = "active";
	document.getElementById("info4").className = "";
}
function info4(){		
	document.getElementById('impacto').style.display='none';
	document.getElementById('ofertas').style.display='none';
	document.getElementById('solicitudes').style.display='block';
	document.getElementById("info2").className = "";
	document.getElementById("info3").className = "";
	document.getElementById("info4").className = "active";
}

document.getElementById('Encargado').style.display='block';	
document.getElementById("user1").className = "active";	
document.getElementById('Profesores').style.display='none';
document.getElementById('Socios').style.display='none';
document.getElementById('Vinculadores').style.display='none';
function user1(){
	document.getElementById('Encargado').style.display='block';	
	document.getElementById('Profesores').style.display='none';
	document.getElementById('Socios').style.display='none';
	document.getElementById('Vinculadores').style.display='none';
	document.getElementById("user1").className = "active";
	document.getElementById("user2").className = "";
	document.getElementById("user3").className = "";
	document.getElementById("user4").className = "";
}
function user2(){
	document.getElementById('Encargado').style.display='none';		
	document.getElementById('Profesores').style.display='block';
	document.getElementById('Socios').style.display='none';
	document.getElementById('Vinculadores').style.display='none';
	document.getElementById("user1").className = "";
	document.getElementById("user2").className = "active";
	document.getElementById("user3").className = "";
	document.getElementById("user4").className = "";
}
function user3(){
	document.getElementById('Encargado').style.display='none';	
	document.getElementById('Profesores').style.display='none';
	document.getElementById('Socios').style.display='block';
	document.getElementById('Vinculadores').style.display='none';
	document.getElementById("user1").className = "";
	document.getElementById("user2").className = "";
	document.getElementById("user3").className = "active";
	document.getElementById("user4").className = "";
}
function user4(){
	document.getElementById('Encargado').style.display='none';		
	document.getElementById('Profesores').style.display='none';
	document.getElementById('Socios').style.display='none';
	document.getElementById('Vinculadores').style.display='block';
	document.getElementById("user1").className = "";
	document.getElementById("user2").className = "";
	document.getElementById("user3").className = "";
	document.getElementById("user4").className = "active";
}

</script>
